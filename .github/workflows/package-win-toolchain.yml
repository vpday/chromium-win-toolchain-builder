name: Package Windows Toolchain

on:
  workflow_dispatch:
    inputs:
      chromium_version:
        description: 'Target Chromium Version'
        required: true
        default: '144.0.7559.96'

permissions:
  contents: write

jobs:
  build_toolchain:
    name: Build (${{ matrix.config.type }})
    runs-on: windows-2025
    strategy:
      fail-fast: false
      matrix:
        config:
          - { type: 'full',  args: '' }
          - { type: 'noarm', args: '--noarm' }

    env:
      VS_VERSION: '2022'
      SDK_VERSION: '10.0.26100.0'
      CHROMIUM_VERSION: ${{ inputs.chromium_version }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          path: src

      - name: Resolve depot_tools Hash
        shell: pwsh
        run: |
          $hash = python src/utils/pin_depot_tools.py "${{ inputs.chromium_version }}"

          if (-not $hash) {
            Write-Error "Failed to resolve depot_tools hash."
            exit 1
          }

          Write-Host "Resolved Hash: $hash"
          echo "DEPOT_TOOLS_HASH=$hash" >> $env:GITHUB_ENV

      - name: Checkout depot_tools
        shell: bash
        run: |
          echo "Cloning depot_tools at commit: $DEPOT_TOOLS_HASH"

          mkdir depot_tools
          cd depot_tools
          git init
          git remote add origin https://chromium.googlesource.com/chromium/tools/depot_tools.git

          git fetch --depth 1 origin $DEPOT_TOOLS_HASH
          git reset --hard FETCH_HEAD

      - name: Verify Windows SDK
        shell: pwsh
        run: |
          $sdkPath = "C:\Program Files (x86)\Windows Kits\10\Include\${{ env.SDK_VERSION }}"
          Write-Host "Checking for SDK at: $sdkPath"

          if (Test-Path $sdkPath) {
            Write-Host "SDK ${{ env.SDK_VERSION }} found."
          } else {
            Write-Host "SDK ${{ env.SDK_VERSION }} NOT found!"
            Write-Host "Available SDKs:"
            Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\Include" | Select-Object Name
            exit 1
          }

      - name: Clean up MSVC versions
        shell: pwsh
        run: |
          $vsRoot = "C:\Program Files\Microsoft Visual Studio\${{ env.VS_VERSION }}\Enterprise"
          $pathsToClean = @("$vsRoot\VC\Tools\MSVC", "$vsRoot\VC\redist\MSVC")

          foreach ($targetPath in $pathsToClean) {
            Write-Host "`nChecking: $targetPath"

            if (Test-Path $targetPath) {
              $versions = Get-ChildItem -Path $targetPath -Directory |
                          Where-Object { $_.Name -match '^\d+\.' } |
                          Sort-Object Name -Descending

              Write-Host "Found numeric versions:"
              $versions | ForEach-Object { Write-Host " - $($_.Name)" }

              if ($versions.Count -gt 1) {
                Write-Host "Multiple numeric versions detected. Keeping the latest one: $($versions[0].Name)"

                $versions | Select-Object -Skip 1 | ForEach-Object {
                  Write-Host "Removing old version: $($_.Name)..."
                  Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction Stop
                }
                Write-Host "Cleanup complete for this path."
              } else {
                Write-Host "Single numeric version found. No cleanup needed."
              }
            } else {
              Write-Host "Path not found: $targetPath"
            }
          }

      - name: Install Windows SDK Debuggers
        shell: pwsh
        run: |
          $debuggersPath = "C:\Program Files (x86)\Windows Kits\10\Debuggers"
          Write-Host "Checking for Debuggers at: $debuggersPath"

          if (-not (Test-Path "$debuggersPath\x86\dbghelp.dll")) {
            Write-Host "Debuggers not found. Downloading Windows SDK 10.0.26100 Installer..."

            $setupUrl = "https://download.microsoft.com/download/5b75beb2-d0fa-4b8e-8e06-a3edc3647ca5/KIT_BUNDLE_WINDOWSSDK_MEDIACREATION/winsdksetup.exe"
            $installerPath = "$env:TEMP\winsdksetup.exe"

            try {
                Write-Host "Downloading from: $setupUrl"
                Invoke-WebRequest -Uri $setupUrl -OutFile $installerPath -ErrorAction Stop
                Write-Host "Installer downloaded to $installerPath"
            } catch {
                Write-Error "Failed to download SDK installer. Error: $_"
                exit 1
            }

            $fileSize = (Get-Item $installerPath).Length
            if ($fileSize -lt 1000000) {
                Write-Error "Downloaded file is too small ($fileSize bytes). Likely a broken link or HTML page."
                exit 1
            }

            Write-Host "Installing Debugging Tools for Windows..."

            $process = Start-Process -FilePath $installerPath -ArgumentList "/features OptionId.WindowsDesktopDebuggers /q /norestart /ceip off" -PassThru -Wait

            Write-Host "Installer Exit Code: $($process.ExitCode)"

            if (Test-Path "$debuggersPath\x86\dbghelp.dll") {
                Write-Host "SUCCESS: Debuggers installed successfully."
                $versionInfo = (Get-Item "$debuggersPath\x86\dbghelp.dll").VersionInfo
                Write-Host "Installed dbghelp.dll version: $($versionInfo.FileVersion)"
            } else {
                Write-Error "FAILURE: Installation finished but dbghelp.dll is still missing."
                exit 1
            }
          } else {
            Write-Host "Debuggers already present. Skipping installation."
          }

      - name: Package Toolchain
        shell: cmd
        working-directory: depot_tools\win_toolchain
        env:
          DEPOT_TOOLS_WIN_TOOLCHAIN: 0
        run: |
          python package_from_installed.py ${{ env.VS_VERSION }} -w ${{ env.SDK_VERSION }} ${{ matrix.config.args }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v6
        with:
          name: toolchain-artifact-${{ matrix.config.type }}
          path: depot_tools/win_toolchain/*.zip
          retention-days: 1

  release_toolchain:
    needs: build_toolchain
    runs-on: windows-2025
    env:
      VS_VERSION: '2022'
      SDK_VERSION: '10.0.26100.0'
      CHROMIUM_VERSION: ${{ inputs.chromium_version }}

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Process Artifacts (Hash & Repackage)
        shell: pwsh
        run: |
          $releaseFiles = @()
          $notesContent = @("### Package Verification", "", "| Variant | Original File | SHA256 | SHA512 |", "|---|---|---|---|")

          $artifactDirs = Get-ChildItem -Path "artifacts" -Directory

          foreach ($dir in $artifactDirs) {
            Write-Host "Processing Artifact: $($dir.Name)"

            $zip = Get-ChildItem -Path $dir.FullName -Filter "*.zip" | Select-Object -First 1
            if (-not $zip) {
                Write-Warning "No zip file found in $($dir.Name)"
                continue
            }

            $variantName = "Unknown"
            $targetBaseName = "win_toolchain_chromium-$($env:CHROMIUM_VERSION)_vs-$($env:VS_VERSION)_sdk-$($env:SDK_VERSION)"

            if ($dir.Name -match "full") {
                $variantName = "Full (With ARM)"
            } elseif ($dir.Name -match "noarm") {
                $variantName = "No ARM"
                $targetBaseName += "_noarm"
            }

            Write-Host "Original File: $($zip.Name)"
            Write-Host "Target Base Name: $targetBaseName"

            Write-Host "Calculating Hashes..."
            $sha256 = (Get-FileHash -Path $zip.FullName -Algorithm SHA256).Hash
            $sha512 = (Get-FileHash -Path $zip.FullName -Algorithm SHA512).Hash

            $notesContent += "| **$variantName** | ``$($zip.Name)`` | ``$sha256`` | ``$sha512`` |"

            $targetTarName = "$targetBaseName.tar"

            $sizeGB = $zip.Length / 1GB
            Write-Host "File Size: $($sizeGB.ToString('N2')) GB"

            if ($zip.Length -gt 2147483648) {
                Write-Host "Size > 2GB. Creating split TAR archive..."
                7z a -ttar "$targetTarName" "$($zip.FullName)" -v1g

                $volumes = Get-ChildItem "$targetTarName.*"
                if ($volumes) {
                    $volumes | ForEach-Object {
                        Write-Host "Generated: $($_.Name)"
                        $releaseFiles += $_.FullName
                    }
                } else {
                    Write-Error "Failed to create split volumes."
                    exit 1
                }
            } else {
                Write-Host "Size <= 2GB. Creating single TAR archive..."
                7z a -ttar "$targetTarName" "$($zip.FullName)"

                if (Test-Path $targetTarName) {
                    Write-Host "Generated: $targetTarName"
                    $releaseFiles += (Get-Item $targetTarName).FullName
                } else {
                    Write-Error "Failed to create tar archive."
                    exit 1
                }
            }
          }

          $notesContent += ""
          $notesContent += "> **Note:** The hashes above are for the **inner source ZIP file** (generated by depot_tools)."
          $notesContent += "> The release files are TAR archives containing this ZIP file."

          $notesPath = "$env:GITHUB_WORKSPACE\release_notes.md"
          $notesContent | Out-File -FilePath $notesPath -Encoding utf8
          Write-Host "Release notes generated."

          $releaseFilesStr = ($releaseFiles | ForEach-Object { $_ -replace '\\', '/' }) -join "`n"
          "RELEASE_FILES<<EOF" >> $env:GITHUB_ENV
          $releaseFilesStr >> $env:GITHUB_ENV
          "EOF" >> $env:GITHUB_ENV

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: ${{ inputs.chromium_version }}
          name: Chromium Toolchain ${{ inputs.chromium_version }}
          body_path: release_notes.md
          files: ${{ env.RELEASE_FILES }}
          fail_on_unmatched_files: true
