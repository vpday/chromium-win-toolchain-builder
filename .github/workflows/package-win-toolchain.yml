name: Package Windows Toolchain

on:
  workflow_dispatch:
    inputs:
      chromium_version:
        description: 'Target Chromium Version'
        required: true
        default: '144.0.7559.96'

permissions:
  contents: write

jobs:
  package:
    runs-on: windows-2025

    env:
      VS_VERSION: '2022'
      SDK_VERSION: '10.0.26100.0'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          path: src

      - name: Resolve depot_tools Hash
        shell: powershell
        run: |
          $hash = python src/utils/pin_depot_tools.py "${{ inputs.chromium_version }}"

          if (-not $hash) {
            Write-Error "Failed to resolve depot_tools hash."
            exit 1
          }

          Write-Host "Resolved Hash: $hash"
          echo "DEPOT_TOOLS_HASH=$hash" >> $env:GITHUB_ENV

      - name: Checkout depot_tools
        shell: bash
        run: |
          echo "Cloning depot_tools at commit: $DEPOT_TOOLS_HASH"

          mkdir depot_tools
          cd depot_tools
          git init
          git remote add origin https://chromium.googlesource.com/chromium/tools/depot_tools.git

          git fetch --depth 1 origin $DEPOT_TOOLS_HASH
          git reset --hard FETCH_HEAD

      - name: Verify Windows SDK
        shell: powershell
        run: |
          $sdkPath = "C:\Program Files (x86)\Windows Kits\10\Include\${{ env.SDK_VERSION }}"
          Write-Host "Checking for SDK at: $sdkPath"

          if (Test-Path $sdkPath) {
            Write-Host "SDK ${{ env.SDK_VERSION }} found."
          } else {
            Write-Host "SDK ${{ env.SDK_VERSION }} NOT found!"
            Write-Host "Available SDKs:"
            Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\Include" | Select-Object Name
            exit 1
          }

      - name: Clean up MSVC versions
        shell: powershell
        run: |
          $vsRoot = "C:\Program Files\Microsoft Visual Studio\${{ env.VS_VERSION }}\Enterprise"

          $pathsToClean = @(
            "$vsRoot\VC\Tools\MSVC",
            "$vsRoot\VC\redist\MSVC"
          )

          foreach ($targetPath in $pathsToClean) {
            Write-Host "`nChecking: $targetPath"

            if (Test-Path $targetPath) {
              $versions = Get-ChildItem -Path $targetPath -Directory |
                          Where-Object { $_.Name -match '^\d+\.' } |
                          Sort-Object Name -Descending

              Write-Host "Found numeric versions:"
              $versions | ForEach-Object { Write-Host " - $($_.Name)" }

              if ($versions.Count -gt 1) {
                Write-Host "Multiple numeric versions detected. Keeping the latest one: $($versions[0].Name)" -ForegroundColor Yellow

                $versions | Select-Object -Skip 1 | ForEach-Object {
                  Write-Host "Removing old version: $($_.Name)..."
                  Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction Stop
                }
                Write-Host "Cleanup complete for this path." -ForegroundColor Green
              } else {
                Write-Host "Single numeric version found. No cleanup needed." -ForegroundColor Green
              }
            } else {
              Write-Host "Path not found: $targetPath" -ForegroundColor Yellow
            }
          }

      - name: Package Toolchain
        shell: cmd
        working-directory: depot_tools\win_toolchain
        env:
          DEPOT_TOOLS_WIN_TOOLCHAIN: 0
        run: |
          python package_from_installed.py ${{ env.VS_VERSION }} -w ${{ env.SDK_VERSION }}

      - name: Repackage with 7z
        shell: powershell
        working-directory: depot_tools\win_toolchain
        run: |
          $sourceZip = Get-ChildItem *.zip | Sort-Object LastWriteTime -Descending | Select-Object -First 1

          if ($sourceZip) {
            Write-Host "Found generated package: $($sourceZip.Name)"
            $targetName = "win_toolchain_chromium-$($env:CHROMIUM_VERSION)_vs-$($env:VS_VERSION)_sdk-$($env:SDK_VERSION).zip"
            Write-Host "Repackaging into: $targetName"

            7z a -tzip $targetName "$($sourceZip.FullName)" -mx=0

            if (Test-Path $targetName) {
                Write-Host "Repackaging successful."
                $newItem = Get-Item $targetName
                echo "RELEASE_ASSET_PATH=$($newItem.FullName)" >> $env:GITHUB_ENV
            } else {
                Write-Error "Failed to create 7z package."
                exit 1
            }
          } else {
            Write-Error "No source zip file generated!"
            exit 1
          }

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: ${{ inputs.chromium_version }}
          name: Chromium Toolchain ${{ inputs.chromium_version }}
          files: ${{ env.RELEASE_ASSET_PATH }}
          fail_on_unmatched_files: true
